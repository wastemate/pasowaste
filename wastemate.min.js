function viewModel(){var a=this;a.history=[],a.lastHash="",a.pendingOrder={},a.showing=ko.observable("search"),a.shouldShowWMA=ko.observable(!1),a.shouldShowSearch=ko.observable(!1),a.shouldShowCategories=ko.observable(!1),a.shouldChooseLob=ko.observable(!1),a.shouldShowResidentialServices=ko.observable(!1),a.shouldShowResidentialLandfill=ko.observable(!1),a.shouldShowResidentialRecycle=ko.observable(!1),a.shouldShowResidentialOrganics=ko.observable(!1),a.shouldShowRollOffMaterials=ko.observable(!1),a.shouldShowRollOffServices=ko.observable(!1),a.shouldChooseStart=ko.observable(!1),a.shouldShowDeliveryAndReview=ko.observable(!1),a.shouldShowBillingInfo=ko.observable(!1),a.shouldShowPaymentInfo=ko.observable(!1),a.shouldShowProcessing=ko.observable(!1),a.shouldShowConfirmation=ko.observable(!1),a.shouldShowProcessNav=ko.observable(!1),a.shouldShowProcessNavFooter=ko.observable(!1),a.shouldShowQuoteInfo=ko.observable(!1),a.noServiceSelection=ko.observable(!1),a.rolloffTermsSubjectToChange=ko.observable(!1),a.rolloffTermsUnderstandCharge=ko.observable(!1),a.rolloffTermsUnderstandRent=ko.observable(!1),a.isRecurringOrder=ko.observable(!1),a.cartsChoosen=ko.observable(!1),a.materialChoosen=ko.observable(!1),a.startChoosen=ko.observable(!1),a.addressConfirmed=ko.observable(!1),a.paymentProcessed=ko.observable(!1),a.requiresMaterial=ko.observable(!1),a.address=ko.observable(),a.categories=ko.observableArray(),a.services=ko.observableArray(),a.landfillServices=ko.observableArray(),a.recyclingServices=ko.observableArray(),a.organicsServices=ko.observableArray(),a.rolloffServices=ko.observableArray(),a.servicesHaveLoaded=ko.observable(),a.selectedService=ko.observable(),a.material=ko.observableArray(),a.selectedMaterial=ko.observable(),a.skipValidateCC=!1,a.materialServices=ko.computed(function(){if(!a.rolloffServices()||!a.selectedMaterial())return[];var b=[];return _.each(a.rolloffServices(),function(c){var d=!1;_.each(a.selectedMaterial().services,function(a){c.materialName==a.materialName&&(d=!0)}),c.enabled=d,c.enabled&&b.push(c)}),b}),a.serviceDay=ko.observable(),a.serviceType=ko.computed(function(){return a.rolloffServices().length?"One-time service":"Weekly services"}),a.fieldWarnings=ko.observable({serviceFirstName:!1,serviceLastName:!1,serviceEmail:!1,servicePhone:!1,serviceAddress:!1,serviceAddressApt:!1,serviceCity:!1,serviceStateShort:!1,serviceZip:!1}),a.formWarning=ko.observableArray([]),a.serviceStartDate=ko.observable(),a.serviceEndDate=ko.observable(),a.serviceFirstName=ko.observable(),a.serviceLastName=ko.observable(),a.serviceEmail=ko.observable(),a.servicePhone=ko.observable(),a.serviceComments=ko.observable(),a.rolloffDatesChoosen=ko.computed(function(){return a.serviceStartDate()&&a.rolloffTermsSubjectToChange()&&a.rolloffTermsUnderstandCharge()&&a.rolloffTermsUnderstandRent()}),a.serviceAddress=ko.observable(),a.serviceCity=ko.observable(),a.serviceStateShort=ko.observable(),a.serviceZip=ko.observable(),a.serviceAddressApt=ko.observable(),a.serviceAddressAptPrint=ko.computed(function(){return a.serviceAddressApt()?"Apt/Suite "+a.serviceAddressApt():""}),a.serviceAddressCityStateZip=ko.computed(function(){return a.serviceCity()+", "+a.serviceStateShort()+" "+a.serviceZip()}),a.serviceAddressFull=ko.computed(function(){return a.serviceAddress()+(a.serviceAddressApt()?" #"+a.serviceAddressApt()+" ":"")+", "+a.serviceCity()+" "+a.serviceStateShort()+" "+a.serviceZip()}),a.userLatLon=ko.observable(),a.serviceMapUrl=ko.observable(),a.recurringTotal=ko.observable(),a.onetimeTotal=ko.observable(),a.billingFirstName=ko.observable(),a.billingLastName=ko.observable(),a.billingEmail=ko.observable(),a.billingPhone=ko.observable(),a.billingAddress=ko.observable(),a.billingCity=ko.observable(),a.billingStateShort=ko.observable(),a.billingZip=ko.observable(),a.billingAddressApt=ko.observable(),a.billingAddressAptPrint=ko.computed(function(){return a.billingAddressApt()?"Apt/Suite "+a.billingAddressApt():""}),a.billingAddressCityStateZip=ko.computed(function(){return a.billingCity()+", "+a.billingStateShort()+" "+a.billingZip()}),a.billingAddressFull=ko.computed(function(){return a.billingAddress()+(a.billingAddressApt()?a.billingAddressApt()+" ":"")+", "+a.billingCity()+" "+a.billingStateShort()+" "+a.billingZip()}),a.billingCard=ko.observable(),a.billingCardExpiresMonth=ko.observable(),a.billingCardExpiresYear=ko.observable(),a.billingCardSecurity=ko.observable(),a.validBillingCard=ko.observable(),a.validBillingCardExpiration=ko.observable(),a.validBillingCardSecurity=ko.observable(),a.wantsAutopay=ko.observable(!0),a.wantsPaperless=ko.observable(!0),a.accountNumber=ko.observable(""),a._billingIsSame=ko.observable(!1),a.makeBillingSame=function(){a.billingAddress(a.serviceAddress()),a.billingAddressApt(a.serviceAddressApt()),a.billingZip(a.serviceZip()),a.billingCity(a.serviceCity()),a.billingStateShort(a.serviceStateShort()),a.billingPhone(a.servicePhone())},a.toggleBillingSame=function(){a._billingIsSame(!a._billingIsSame()),console.log("billingIsSame",a._billingIsSame()),a._billingIsSame()?a.makeBillingSame():(a.billingAddress(""),a.billingAddressApt(""),a.billingZip(""),a.billingCity(""),a.billingStateShort(""),a.billingPhone(""))},a.ccExpireYearOptions=ko.computed(function(){for(var a=[],b=new Date,c=0;10>c;c++)b.setFullYear(b.getFullYear()+c),a.push({value:b.toJSON().substring(0,4)});return a}),a.avaiableDeliveryDates=ko.computed(function(){if(_.isNumber(a.serviceDay())){var b=function(b){var c=a.serviceDay(),d=7*b,e=moment().day(0).add(d+c,"days").toDate(),f={date:e,isoString:e.toJSONLocal()};return f},c=moment().add(24,"hours"),d=6,e=[],f=function(){var a=b(e.length),g=DateHelper.getHoliday(a.date);g?a=null:c.isAfter(a.date)&&(a=null),e.push(a),e.length<d?f():console.log("built list")};return f(),e=_.compact(e)}}),a.selectedServices=ko.computed(function(){if(!a.servicesHaveLoaded())return[];var b=[],c=[a.landfillServices,a.recyclingServices,a.organicsServices,a.rolloffServices];return _.each(c,function(a){var c=_.find(a(),function(a){return a.selected===!0});c&&b.push(c)}),b}),a.humanDeliveryDay=ko.computed(function(){var b="",c=a.serviceDay();if(Number(c)===c)switch(c){case 0:b="Sunday";break;case 1:b="Monday";break;case 2:b="Tuesday";break;case 3:b="Wednesday";break;case 4:b="Thursday";break;case 5:b="Friday";break;case 6:b="Saturday";break;default:b=""}return b}),a.selectedServicePrice=ko.computed(function(){var b=0,c=ko.utils.arrayFirst(a.landfillServices(),function(a){return 1==a.selected}),d=ko.utils.arrayFirst(a.recyclingServices(),function(a){return 1==a.selected}),e=ko.utils.arrayFirst(a.organicsServices(),function(a){return 1==a.selected}),f=ko.utils.arrayFirst(a.rolloffServices(),function(a){return 1==a.selected});return c&&(b+=c.price),d&&(b+=d.price),e&&(b+=e.price),f&&(b+=f.price),b}),a.formattedServiceName=ko.computed(function(){return a.serviceFirstName()+" "+a.serviceLastName()}),a.isOneTimePrice=ko.computed(function(){var b=ko.utils.arrayFirst(a.rolloffServices(),function(a){return 1==a.selected});return b?!0:!1}),a.orderTotal=ko.computed(function(){var b=a.selectedServicePrice();if(a.wantsAutopay()||a.isOneTimePrice()||(b=2*b),a.isOneTimePrice()&&a.selectedService()&&a.serviceEndDate()){var c=a.selectedService().rent,d=a.selectedService().rentDays,e=moment(a.serviceEndDate()).diff(moment(a.serviceStartDate())),f=moment.duration(e),g=~~(f.asDays()-2);if(g>d){var h=~~((g-d)*c*100)/100;b+=h}}return"$"+b}),a.recurringTotal=ko.computed(function(){return"$"+a.selectedServicePrice()}),a.serviceMapUrl=ko.computed(function(){if(a.userLatLon()){_.templateSettings.interpolate=/{{ ([\s \S]+?)}}/g;var b=_.template("http://api.tiles.mapbox.com/v4/{{ mapid }}/{{ pin }}-{{ label }}+{{ color }}({{ lon }},{{ lat }})/{{ lon }},{{ lat }},{{ z }}/{{ width }}x{{ height }}.{{ format }}?access_token={{ token }}");return b({pin:"pin-s",label:"marker",color:"482",mapid:"mapbox.streets",lon:a.userLatLon().lon,lat:a.userLatLon().lat,z:17,width:150,height:150,format:"jpg",token:"pk.eyJ1IjoiamVkZGF3c29uIiwiYSI6ImMxYjczZWRkNzFkNWU3YzhmMTAyNzdjMjBlYThiODk2In0.HsgA69IWdvwYJyaCT7TUUg"})}}),a.loadCategory=function(b,c){console.log("Clicked"),console.log(b),a.show("processing"),wastemate.getServices(b.line).then(function(c){if(0==c.length)return a.generateQuoteFor=b.line,a.noServiceSelection(!0),a.show("quote"),void setupMiniMap(a.userLatLon().lat,a.userLatLon().lon);if(a.services([]),a.landfillServices([]),a.recyclingServices([]),a.organicsServices([]),a.rolloffServices([]),$.each(c,function(b,c){a.services.push(c),"Landfill"==c.type.name&&(c.selected=!1,c.summary="Landfill service",a.landfillServices.push(c)),"Recycling"==c.type.name&&(c.selected=!1,c.summary="Recycling service",a.recyclingServices.push(c)),"Organics"==c.type.name&&(c.selected=!1,c.summary="Recycling service",a.organicsServices.push(c)),("RollOff"==c.type.name||c.isRecurring===!1)&&(c.selected=!1,c.summary="on-call service",a.rolloffServices.push(c))}),a.landfillServices.sort(function(a,b){return a.name==b.name?0:a.name<b.name?-1:1}),a.recyclingServices.sort(function(a,b){return a.name==b.name?0:a.name<b.name?-1:1}),a.organicsServices.sort(function(a,b){return a.name==b.name?0:a.name<b.name?-1:1}),a.rolloffServices.sort(function(a,b){return a.name==b.name?0:a.name<b.name?-1:1}),a.selectResidentialDefaults(a.landfillServices,!0),a.selectResidentialDefaults(a.recyclingServices,!1),a.selectResidentialDefaults(a.organicsServices,!1),a.servicesHaveLoaded(!0),a.rolloffServices().length){var d=[];_.each(a.rolloffServices(),function(a){d.push(a.materials)}),d=_.flattenDeep(d),d=_.uniq(d,function(a){return a.name}),_.each(d,function(b){b.services=b.services||[],_.each(a.rolloffServices(),function(a){a.materialName==b.name&&b.services.push(a)})}),a.material(d),console.log(d),a.show("materials")}else{var e=!1;if(void 0!=a.pendingOrder.service){var f=a.pendingOrder.service;_.each(a.landfillServices(),function(b){b.guid==f&&(a.selectProductService(b,"automagic selection"),a.pendingOrder={},e=!0)})}e||a.show("residentialLandfill")}},function(a){a&&alert("Address required before choosing service category")})},a.showCategories=function(b,c){a.show("categories")},a.loadServices=function(a,b){console.log("Address submitted")},a.selectMaterial=function(b,c){if(hasMatch=ko.utils.arrayFirst(a.material(),function(a){return a==b}),hasMatch&&(a.materialChoosen(!0),ko.utils.arrayForEach(a.material(),function(c){c.selected=c==b,c.selected&&a.selectedMaterial(c),c.summary=" material"})),a.material.valueHasMutated(),_.each(a.rolloffServices(),function(a){a.selected=!1}),a.selectedService(null),a.cartsChoosen(!1),1==a.selectedMaterial().services.length){var d=a.selectedMaterial().services[0];a.selectProductService(d)}a.next()},a.isResidential=function(b){var c=!1;return _.each([a.landfillServices(),a.recyclingServices(),a.organicsServices()],function(a){_.each(a,function(a){a.guid==b.guid&&(c=!0)})}),c},a.selectProductShow=function(b){a.isResidential(b)?a.show("residential"):a.show("rolloff")},a.buttonOrderService=function(b,c){!b&&c?a.pendingOrder={line:c}:b&&c&&(a.pendingOrder={line:c,service:b})},a.selectProductService=function(b,c){if("undefined"==typeof b.enabled||b.enabled){if(b.selected)return a.selectProductShow(b),void a.next();var d=[a.landfillServices,a.recyclingServices,a.organicsServices,a.rolloffServices];_.each(d,function(a){var c=a(),d=_.find(c,function(a){return a.guid===b.guid});d&&(_.each(c,function(a){a.selected=a.guid===b.guid}),a(c))}),a.selectedService(b),a.selectProductShow(b),console.log("choose item: ",b),a.next()}},a.onClickCartChangeSize=function(b,c){console.log("event",c),console.log("data",b),_.contains(a.landfillServices(),b)?(a.show("residentialLandfill"),console.log("show residentialLandfill")):_.contains(a.recyclingServices(),b)?(a.show("residentialRecycle"),console.log("show residentialRecycle")):_.contains(a.organicsServices(),b)&&(a.show("residentialOrganics"),console.log("show residentialOrganics"))},a.selectResidentialDefaults=function(a,b){var c=a();if(c&&!_.isEmpty(c)){var d=b?_.first(c):_.last(c);d&&(d.selected=!0,a.valueHasMutated())}},a.previous=function(b,c){if(window.location.hash==a.lastHash)return void(a.lastHash="");a.history.pop();var d=a.history.pop();return d?(console.log("previous: "+d),window.scrollTo(window.scrollX,0),a.show(d),!0):!1},a.manageHistory=function(b){a.lastHash=window.location.hash,console.log("manageHistory: "+a.lastHash),"search"==b&&(a.history=[]),"processing"!=b&&b!=a.history[a.history.length-1]&&a.history.push(b)},a.next=function(b,c){switch(window.scrollTo(window.scrollX,0),a.showing()){case"residential":a.saveOrder(c,function(b){var c=[];_.each(a.avaiableDeliveryDates(),function(a){c.push(moment(a.date).toDate())});var d=[];_.times(365,function(a){var b=moment().add(a,"days"),e=!0;_.each(c,function(a){moment(b).isSame(a,"day")&&(e=!1)}),e&&d.push(b.toDate())}),$("#first-pickup-date-text").html(moment(a.serviceStartDate()||c[0]).format("L")),$("#wma-rolloff-dropoff-text").html(moment(a.serviceStartDate()||c[0]).format("L")),$("#wma-rolloff-pickup-text").html(moment(a.serviceStartDate()||c[0]).format("L")),a.serviceStartDate(moment(a.serviceStartDate()||c[0]).toDate()),a.serviceEndDate(moment(a.serviceStartDate()||c[0]).toDate());var e=$("#first-pickup-datepicker").datetimepicker({icons:{date:"fa fa-calendar",up:"fa fa-arrow-up",down:"fa fa-arrow-down"},format:"MM/dd/YY",minDate:moment(),inline:!0,disabledDates:d,sideBySide:!1,defaultDate:a.serviceStartDate()||c[0]});e.on("dp.change",function(b){var c=b.date;a.serviceStartDate(c.toDate()),$("#first-pickup-date-text").html(c.format("L")),console.log("changed",c)}),a.cartsChoosen(!0),a.show("chooseStart")});break;case"materials":if(!a.materialChoosen())return void alert("Please choose a material.");a.show("rolloff");break;case"rolloff":if(_.each(a.services(),function(b){b.selected&&a.cartsChoosen(!0)}),!a.cartsChoosen())return void alert("Please select a bin.");var d=14,e=function(a,b){var c=[],d=[];return _.times(b,function(b){var e=moment(a).add(b,"days"),f=DateHelper.getHoliday(e),g=DateHelper.isWeekday(e),h=moment(e).toDate();!f&&g?c.push(h):d.push(h)}),{daysValid:c,daysInvalid:d}},f=e(moment().add(1,"days"),d);availableDates=f.daysValid,invalidDates=f.daysInvalid,$("#wma-rolloff-dropoff-date-text").html(moment(a.serviceStartDate()||availableDates[0]).format("L")),a.serviceStartDate(moment(a.serviceStartDate()||availableDates[0]).toDate()),a.serviceEndDate(null);var g=moment(a.serviceStartDate()||availableDates[0]),h=$("#wma-rolloff-dropoff-datepicker").datetimepicker({icons:{date:"fa fa-calendar",up:"fa fa-arrow-up",down:"fa fa-arrow-down"},format:"MM/dd/YY",minDate:g,maxDate:availableDates[availableDates.length-1],inline:!0,disabledDates:invalidDates,sideBySide:!1,defaultDate:g});h.on("dp.change",function(b){var c=b.date;a.serviceStartDate(c.toDate()),$("#wma-rolloff-dropoff-date-text").html(c.format("L")),k(c)});var i,j=function(){i&&$("#wma-rolloff-pickup-datepicker").data("DateTimePicker").destroy();var b=28,c=e(moment(a.serviceStartDate()).add(1,"days"),b),d=c.daysValid,f=c.daysInvalid,g=d[0],h=d[d.length-1];i=$("#wma-rolloff-pickup-datepicker").datetimepicker({icons:{date:"fa fa-calendar",up:"fa fa-arrow-up",down:"fa fa-arrow-down"},format:"MM/dd/YY",minDate:g,maxDate:h,inline:!0,disabledDates:f,sideBySide:!1}),$("#wma-rolloff-pickup-datepicker").data("DateTimePicker").clear(),i.on("dp.change",function(b){var c=b.date;c&&(a.serviceEndDate(c.toDate()),$("#wma-rolloff-pickup-date-text").val(c.format("L")),console.log("changed",c))})},k=function(b){if(i){var c=28,d=e(moment(a.serviceStartDate()).add(1,"days"),c),f=d.daysValid,g=(d.daysInvalid,f[0]),h=f[f.length-1];$("#wma-rolloff-pickup-datepicker").data("DateTimePicker").minDate(g),$("#wma-rolloff-pickup-datepicker").data("DateTimePicker").maxDate(h);var j=a.serviceEndDate();j&&moment(j).isBefore(b)&&(a.serviceEndDate(null),$("#wma-rolloff-pickup-date-text").val(""),$("#wma-rolloff-pickup-datepicker").data("DateTimePicker").clear())}};$("#wma-rolloff-pickup-date-text").on("change",function(b){console.log(b);var c=b.target.value;if(0===c.length)return console.log("user cleared removal date"),a.serviceEndDate(null),void $("#wma-rolloff-pickup-datepicker").data("DateTimePicker").clear();if(c){var d=moment(c);if(d.isValid()){var e=moment(a.serviceStartDate());e.isBefore(d)||(a.serviceEndDate(null),$("#wma-rolloff-pickup-date-text").val(""),alert("Removal date isn't valid. It must be at lease 1 day after the delivery date."))}else a.serviceEndDate(null),$("#wma-rolloff-pickup-date-text").val(""),alert("Removal date isn't valid. Use date picker or enter date as MM/dd/YYYY")}}),j(),a.show("processing"),a.saveOrder(c,function(b){return b?void console.log("Could not save order."):void a.show("deliveryAndReview")});break;case"deliveryAndReview":if(!a.rolloffTermsUnderstandCharge()||!a.rolloffTermsSubjectToChange()||!a.rolloffTermsUnderstandRent())return void alert("You must agree with the terms to continue.");var l;try{l=moment(a.serviceStartDate()).toDate().toISOString()}catch(m){return void alert("Please choose a delivery date.")}var n=null;try{n=moment(a.serviceEndDate()).toDate().toISOString()}catch(m){_wastemate.REQUIRE_REMOVAL_DATE&&alert("Please choose a removal date.")}wastemate.setOnDemandDates(l,n).then(function(){a.startChoosen(!0),a.show("siteInfo"),setupMiniMap(a.userLatLon().lat,a.userLatLon().lon)},function(a){alert("Ooops something failed :("),console.log(a)});break;case"categories":break;case"chooseStart":var o;try{o=new Date(a.serviceStartDate()).toISOString()}catch(m){return void alert("Please select a start date.")}wastemate.setRecurringStartDate(o).then(function(){a.startChoosen(!0),a.show("siteInfo"),setupMiniMap(a.userLatLon().lat,a.userLatLon().lon)},function(a){alert("Ooops something failed :("),console.log(a)});break;case"siteInfo":var p={firstName:a.serviceFirstName()||"",lastName:a.serviceLastName()||"",email:a.serviceEmail()||"",phone:a.servicePhone()||"",address:a.serviceAddressFull()||"",street:a.serviceAddress()||"",city:a.serviceCity()||"",state:a.serviceStateShort()||"",suite:a.serviceAddressApt()||"",zip:a.serviceZip()||""};a.fieldWarnings().serviceFirstName=!1,a.fieldWarnings().serviceLastName=!1,a.fieldWarnings().serviceEmail=!1,a.fieldWarnings().serviceAddress=!1,a.fieldWarnings().serviceCity=!1,a.fieldWarnings().serviceStateShort=!1,a.fieldWarnings().serviceZip=!1,a.formWarning([]),""==p.firstName&&(a.fieldWarnings().serviceFirstName=!0,a.formWarning.push({strong:"Oops! ",message:"Missing your first name."})),""==p.lastName&&(a.fieldWarnings().serviceLastName=!0,a.formWarning.push({strong:"",message:"Missing your last name."})),""!=p.email||a.skipValidateCC||(a.fieldWarnings().serviceEmail=!0,a.formWarning.push({strong:"",message:"Missing your email."})),""==p.street&&(a.fieldWarnings().serviceAddress=!0,a.formWarning.push({strong:"",message:"Missing your street address."})),""==p.city&&(a.fieldWarnings().serviceCity=!0,a.formWarning.push({strong:"",message:"Missing your city."})),""==p.state&&(a.fieldWarnings().serviceStateShort=!0,a.formWarning.push({strong:"",message:"Missing your state."})),""==p.zip&&(a.fieldWarnings().serviceZip=!0,a.formWarning.push({strong:"",message:"Missing your zip code."}));var q=function(a){var b=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return b.test(a)};if(q(p.email)||a.skipValidateCC||(a.fieldWarnings().serviceEmail=!0,a.formWarning.push({strong:"",message:"That email address isn't valid."})),a.formWarning().length)return void a.fieldWarnings.notifySubscribers();var r=a.userLatLon().lat,s=a.userLatLon().lon;wastemate.updateAddressLocation(r,s).then(function(){wastemate.saveServiceInformation(p).then(function(){a.addressConfirmed(!0),a.show("payment")},function(b){console.log(b),a.formWarning.push({strong:"Service Error: ",message:"Something isn't right. Please try again."})})},function(b){console.log(b),a.formWarning.push({strong:"Service Error: ",message:"Something isn't right. Please try again."})});break;case"quote":var p={firstName:a.serviceFirstName()||"",lastName:a.serviceLastName()||"",email:a.serviceEmail()||"",phone:a.servicePhone()||"",address:a.serviceAddressFull()||"",street:a.serviceAddress()||"",city:a.serviceCity()||"",state:a.serviceStateShort()||"",suite:a.serviceAddressApt()||"",zip:a.serviceZip()||"",comments:a.serviceComments()||""};a.fieldWarnings().serviceFirstName=!1,a.fieldWarnings().serviceLastName=!1,a.fieldWarnings().serviceEmail=!1,a.fieldWarnings().serviceAddress=!1,a.fieldWarnings().serviceCity=!1,a.fieldWarnings().serviceStateShort=!1,a.fieldWarnings().serviceZip=!1,a.formWarning([]),""==p.firstName&&(a.fieldWarnings().serviceFirstName=!0,a.formWarning.push({strong:"Oops! ",message:"Missing your first name."})),""==p.lastName&&(a.fieldWarnings().serviceLastName=!0,a.formWarning.push({strong:"",message:"Missing your last name."})),""!=p.email||a.skipValidateCC||(a.fieldWarnings().serviceEmail=!0,a.formWarning.push({strong:"",message:"Missing your email."})),""==p.street&&(a.fieldWarnings().serviceAddress=!0,a.formWarning.push({strong:"",message:"Missing your street address."})),""==p.city&&(a.fieldWarnings().serviceCity=!0,a.formWarning.push({strong:"",message:"Missing your city."})),""==p.state&&(a.fieldWarnings().serviceStateShort=!0,a.formWarning.push({strong:"",message:"Missing your state."})),""==p.zip&&(a.fieldWarnings().serviceZip=!0,a.formWarning.push({strong:"",message:"Missing your zip code."}));var q=function(a){var b=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return b.test(a)};if(q(p.email)||a.skipValidateCC||(a.fieldWarnings().serviceEmail=!0,a.formWarning.push({strong:"",message:"That email address isn't valid."})),a.formWarning().length)return void a.fieldWarnings.notifySubscribers();var r=a.userLatLon().lat,s=a.userLatLon().lon;wastemate.saveServiceInformation(p).then(function(){wastemate.processQuoteRequest(a.generateQuoteFor).then(function(){a.accountNumber((new Date).getTime()),a.show("confirmation")},function(b){a.formWarning.push({strong:"Service Error: ",message:"Something isn't right. Please try again."})})},function(b){console.log(b),a.formWarning.push({strong:"Service Error: ",message:"Something isn't right. Please try again."})});break;case"payment":if(a.saveOrderInFlight)return;if(a.formWarning([]),a.validBillingCard()||a.skipValidateCC||a.formWarning.push({strong:"Payment: ",message:"Please enter a valid card number."}),a.validBillingCardExpiration()||a.skipValidateCC||a.formWarning.push({strong:"Payment: ",message:"Please enter a valid expiration date."}),a.validBillingCardSecurity()||a.skipValidateCC||a.formWarning.push({strong:"Payment: ",message:"Please enter a valid security code."}),a.billingFirstName()&&""!=a.billingFirstName()||a.formWarning.push({strong:"Payment: ",message:"Missing first name."}),a.billingLastName()&&""!=a.billingLastName()||a.formWarning.push({strong:"Payment: ",message:"Missing last name."}),a.billingAddress()&&""!=a.billingAddress()||a.formWarning.push({strong:"Billing: ",message:"Missing billing address."}),a.billingStateShort&&""!=a.billingStateShort()||a.formWarning.push({strong:"Billing: ",message:"Missing billing state."}),a.billingCity&&""!=a.billingCity()||a.formWarning.push({strong:"Billing: ",message:"Missing billing city."}),a.billingZip()&&""!=a.billingZip()||a.formWarning.push({strong:"Billing: ",message:"Missing zip code."}),a.formWarning().length)return;a.saveOrderInFlight=!0,a.formWarning([]),a.show("processing");var t=function(){wastemate.saveBillingSelection({name:a.billingFirstName()+" "+a.billingLastName(),street:a.billingAddress(),city:a.billingCity(),state:a.billingStateShort(),zip:a.billingZip(),phone:a.billingPhone()||a.servicePhone()}),wastemate.setBillingOptions(a.wantsAutopay(),a.wantsPaperless()),wastemate.processNewOrder().then(function(b){a.saveOrderInFlight=!1,console.log(b),a.accountNumber(b.C_ID),wastemate._private.account.set("accountNumber",b.C_ID),wastemate._private.account.save(),a.show("confirmation")},function(b){a.saveOrderInFlight=!1,a.show("payment"),console.log(b),b&&a.formWarning.push({strong:"Service Error: ",message:"There was a problem processing your order. Please try again."})})};if(a.billingCard()){var u={cardNumber:a.billingCard().replace(/\s/g,""),ccExpiresMonth:Number(a.billingCardExpiresMonth()),ccExpiresYear:Number(a.billingCardExpiresYear()),securityCode:a.billingCardSecurity(),fullName:a.billingFirstName()+" "+a.billingLastName(),address:a.billingAddress(),zipCode:a.billingZip()};u.cardType=$.payment.cardType(u.cardNumber),wastemate.tokenizeCard(u).then(function(b){wastemate._private.order.cardToken=b;var c=a.selectedServicePrice();a.wantsAutopay()||a.isOneTimePrice()||(c=2*c),c=~~(100*parseFloat(c)),wastemate.preAuthorizePayment(c,u).then(function(b){wastemate._private.order.set("amount",c),wastemate._private.order.set("delayedCaptureToken",b.creditCardToken),wastemate._private.order.save(),a.paymentProcessed(!0),t()},function(b){a.saveOrderInFlight=!1,a.show("payment"),console.log(b),b&&a.formWarning.push({strong:"Payment Error: ",message:"Unable to process payment. Check credit card information and try again."})})},function(b){a.saveOrderInFlight=!1,a.show("payment"),console.log(b),b&&a.formWarning.push({strong:"Payment Error: ",message:"Credit card validation error. Check credit card information and try again."})})}else t()}},a.saveOrderInFlight=!1,a.saveOrder=function(b,c){if(!a.saveOrderInFlight){a.saveOrderInFlight=!0;var d=[a.landfillServices,a.recyclingServices,a.organicsServices,a.rolloffServices],e=[],f=[];if(_.each(d,function(a){var b=_.find(a(),function(a){return a.selected===!0});if(b)f.push(_.clone(b));else if(!_.isEmpty(a())){var c=a()[0].type.name;e.push("a "+c.toLower()+" service")}}),e.length>0)return void c(e);var g=a.selectedMaterial();g&&(g={icon:g.icon,name:g.name}),_.each(f,function(a){delete a.material,delete a.enabled,delete a.selected}),wastemate.saveServiceSelection(f,g).then(function(){console.log("saved service selection"),a.saveOrderInFlight=!1,c()},function(b){console.log("something went wrong"),console.log(b),a.saveOrderInFlight=!1,c(b)})}},a.show=function(b){console.log(b);try{window.invalidateAllInputs()}catch(c){}a.manageHistory(b),a.materialServices(),a._billingIsSame()&&a.makeBillingSame();var d=function(){a.shouldShowSearch(!1),a.shouldShowCategories(!1),a.shouldShowResidentialServices(!1),a.shouldShowResidentialLandfill(!1),a.shouldShowResidentialRecycle(!1),a.shouldShowResidentialOrganics(!1),a.shouldShowRollOffMaterials(!1),a.shouldShowRollOffServices(!1),a.shouldShowDeliveryAndReview(!1),a.shouldShowBillingInfo(!1),a.shouldShowPaymentInfo(!1),a.shouldShowConfirmation(!1),a.shouldShowProcessNav(!1),a.shouldShowProcessNavFooter(!1),a.shouldChooseStart(!1),a.shouldShowProcessing(!1),a.shouldShowQuoteInfo(!1)};switch(b){case"loading":d();break;case"search":d(),a.shouldShowSearch(!0);break;case"categories":d();var e=$("#"+_wastemate.ui.hide||"body");e&&(a.shouldShowWMA(!0),e.hide()),1===a.categories().length?a.loadCategory(a.categories()[0]):a.shouldShowCategories(!0);break;case"residential":d(),a.shouldShowResidentialServices(!0),a.shouldShowProcessNav(!0),a.shouldShowProcessNavFooter(!0);break;case"residentialLandfill":d(),a.shouldShowResidentialLandfill(!0),a.shouldShowProcessNav(!0);break;case"residentialRecycle":d(),a.shouldShowResidentialRecycle(!0),a.shouldShowProcessNav(!0);break;case"residentialOrganics":d(),a.shouldShowResidentialOrganics(!0),a.shouldShowProcessNav(!0);break;case"chooseStart":d(),a.shouldChooseStart(!0),a.shouldShowProcessNav(!0),a.shouldShowProcessNavFooter(!0);break;case"deliveryAndReview":d(),a.shouldShowDeliveryAndReview(!0),a.shouldShowProcessNav(!0);break;case"materials":d(),a.shouldShowRollOffMaterials(!0),a.shouldShowProcessNav(!0);break;case"rolloff":d(),a.shouldShowRollOffServices(!0),a.shouldShowProcessNav(!0);break;case"siteInfo":d(),a.shouldShowBillingInfo(!0),a.shouldShowProcessNav(!0);break;case"quote":d(),a.shouldShowQuoteInfo(!0),a.shouldShowProcessNav(!0);break;case"payment":d(),a.shouldShowPaymentInfo(!0),a.shouldShowProcessNav(!0);break;case"processing":d(),a.shouldShowProcessing(!0);break;case"confirmation":d(),a.shouldShowConfirmation(!0),a.shouldShowProcessNav(!0);break;default:d()}a.showing(b)}}function bindViewFormatters(){$("#wma-cst-crdnbr").payment("formatCardNumber"),$("#wma-cst-crdnbr").on("keyup",function(){_wastemate.viewModel.validBillingCard(!1);var a=$(this).val().replace(/\s/g,""),b=$.payment.validateCardNumber(a);16!=a.length||b?16==a.length&&b?(_wastemate.viewModel.validBillingCard(!0),$(this).css("border","2px solid #007700"),$("#wma-cst-expmm").focus()):$(this).css("border",""):$(this).css("border","2px solid #FFCCCC");var c=$.payment.cardType(a);$("[id^=wma-cc-]").css("opacity",.3).addClass("greyscale"),("visa"==c||"amex"==c||"discover"==c||"mastercard"==c)&&$("#wma-cc-"+c).css("opacity",1).removeClass("greyscale"),a.length||$("[id^=wma-cc-]").css("opacity",1).removeClass("greyscale")}),$("#wma-cst-cvv").payment("formatCardCVC"),$("#wma-cst-cvv").on("keyup",function(){_wastemate.viewModel.validBillingCardSecurity(!1);var a=$(this).val(),b=$.payment.validateCardCVC(a);a.length>=3&&!b?$(this).css("border","2px solid #FFCCCC"):a.length>=3&&b?(_wastemate.viewModel.validBillingCardSecurity(!0),$(this).css("border","2px solid #007700")):$(this).css("background-color","")}),function(){var a=function(a){_wastemate.viewModel.validBillingCardExpiration(!1),a?(_wastemate.viewModel.validBillingCardExpiration(!0),$("#wma-cst-expmm").css("border","2px solid #007700"),$("#wma-cst-expyy").css("border","2px solid #007700")):-1==$("#wma-cst-expmm").val()||-1==$("#wma-cst-expyy").val()?($("#wma-cst-expmm").css("border",""),$("#wma-cst-expyy").css("border","")):($("#wma-cst-expmm").css("border","2px solid #FFCCCC"),$("#wma-cst-expyy").css("border","2px solid #FFCCCC"))};$("#wma-cst-expmm").on("change",function(){var b=$(this).val(),c=$("#wma-cst-expyy").val(),d=$.payment.validateCardExpiry(b,c);a(d)}),$("#wma-cst-expyy").on("change",function(){var b=$("#wma-cst-expmm").val(),c=$(this).val(),d=$.payment.validateCardExpiry(b,c);a(d)})}(),$("#wma-cst-phn").inputmask("mask",{mask:"(999) 999-9999"}),$("#wma-cst-billingphn").inputmask("mask",{mask:"(999) 999-9999"}),$("#wma-cst-billsameaddr").on("change",function(){_wastemate.viewModel.toggleBillingSame();try{window.invalidateAllInputs()}catch(a){}}),$(".wma-billing-input").on("keyup",function(){_wastemate.viewModel._billingIsSame(!1),$("#wma-cst-billsameaddr").removeAttr("checked")}),$(function(){$('[data-toggle="tooltip"]').tooltip()})}$(document).ready(function(){var a="custom-input-label",b="6px 12px",c="12px 12px 0px 12px",d="slideUp",e=50,f="#BBB",g=12,h="6px 12px",i=function(a,d){var e=$(a).parent().find("label");d?($(e).css("display",""),$(a).css("padding",c,"important")):($(e).css("display","none"),$(a).css("padding",b,"important"))};window.invalidateAllInputs=function(){$("input[placeholder][type=text]").each(function(){i(this,!!$(this).val().length)})},$("input[placeholder][type=text]").each(function(){$(this).css("height",e).css("padding",b);var c=$(this).attr("placeholder");$("<label/>",{text:c,"class":a}).css("font-weight","bold").css("color",f).css("font-size",g).css("padding",h).css("position","absolute").css("visibility","hidden").addClass(d).insertBefore($(this)),$(this).on("keyup",function(){$(this).val().length?i(this,!0):i(this,!1)})})}),function(){"use strict";var a=this,b=this.wastemate;Date.prototype.toISOString||!function(){function a(a){return 10>a?"0"+a:a}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}}();var c={_private:{
host:"https://manage.wastemate.com/api/",organizationToken:"",parseAppId:"",parseJsKey:"",ccRequired:!0},_config:{getLines:function(){return c._private.host+"lob/"+c._private.organizationToken},getServices:function(a,b){return c._private.host+"services/"+c._private.organizationToken+"/"+a+"?lat="+b.lat+"&lon="+b.lon},updateLocation:function(){return c._private.host+"services/validate/"+c._private.organizationToken},getServiceDay:function(a){return c._private.host+"services/dow/"+c._private.organizationToken+"?lat="+a.lat+"&lon="+a.lon},tokenizeCard:function(a){return c._private.host+"creditCard/tokenize/"+c._private.organizationToken+"/"+a},preAuthorizeCard:function(a){return c._private.host+"creditCard/payment/"+c._private.organizationToken+"/"+a},processOrder:function(){return c._private.host+"order/"+c._private.organizationToken},processQuote:function(){return c._private.host+"order/quote/"+c._private.organizationToken}},_cached:{cachFor:6e5,_lob:null,_lobWhen:0,_services:null,_servicesWhen:0,clear:function(){c._cached._lob=null,c._cached._lobWhen=0,c._cached._service=null,c._cached._serviceWhen=0},lob:{get:function(){var a=Date.now();return c._cached._lob&&a-c._cached._lobWhen<c._cached.cachFor?c._cached._lob:null},set:function(a){return c._cached._lob=a,c._cached._lobWhen=Date.now(),a}},services:{get:function(){var a=Date.now();return c._cached._services&&a-c._cached._servicesWhen<c._cached.cachFor?c._cached._services:null},set:function(a){return c._cached._services=a,c._cached._servicesWhen=Date.now(),a}}},updateAddressLocation:function(a,b){return new Promise(function(d,e){var f={oldLocation:{lat:c._private.account.get("lat"),lon:c._private.account.get("lon")},newLocation:{lat:a,lon:b}},g=new XMLHttpRequest;g.open("POST",c._config.updateLocation()),g.setRequestHeader("Accept","application/json"),g.setRequestHeader("Content-Type","application/json;charset=UTF-8"),g.onload=function(){if(200===g.status){var f=JSON.parse(g.responseText);f.samePricing&&f.sameRouting?(c._private.account.set("lat",a),c._private.account.set("lon",b),c._private.account.save(),d(f)):e(f)}else e(new Error(g.errorMessage))},g.onerror=function(){e(new Error("Network Error"))},g.send(JSON.stringify(f))})},getServiceCategories:function(){return new Promise(function(a,b){var d=c._cached.lob.get();if(d)return void a(d);var e=new XMLHttpRequest;e.open("GET",c._config.getLines()),e.setRequestHeader("Accept","application/json"),e.setRequestHeader("Content-Type","application/json;charset=UTF-8"),e.onload=function(){200===e.status?a(c._cached.lob.set(JSON.parse(e.responseText))):b(new Error(e.statusText))},e.onerror=function(){b(new Error("Network Error"))},e.send()})},getServices:function(a){return new Promise(function(b,d){var e=c._cached.services.get();if(e)return void b(e);if(!c._private.account)return void d(new Error("Account must be set before resolving services"));var f={lat:c._private.account.get("lat"),lon:c._private.account.get("lon")},g=new XMLHttpRequest;g.open("GET",c._config.getServices(a,f)),g.setRequestHeader("Accept","application/json"),g.setRequestHeader("Content-Type","application/json;charset=UTF-8"),g.onload=function(){200===g.status?(c.URL.appendHash("line",btoa(a)),b(c._cached.services.set(JSON.parse(g.responseText)))):d(new Error(g.statusText))},g.onerror=function(){d(new Error("Network Error"))},g.send()})},getServiceDayOfWeek:function(){return new Promise(function(a,b){if(!c._private.account)return void b(new Error("Account must be set before resolving services"));var d={lat:c._private.account.get("lat"),lon:c._private.account.get("lon")},e=new XMLHttpRequest;e.open("GET",c._config.getServiceDay(d)),e.setRequestHeader("Accept","application/json"),e.setRequestHeader("Content-Type","application/json;charset=UTF-8"),e.onload=function(){200===e.status?a(JSON.parse(e.responseText)):b(new Error(e.statusText))},e.onerror=function(){b(new Error("Network Error"))},e.send()})},tokenizeCard:function(a){return new Promise(function(b,d){if(!c._cached.services)return void d(new Error("Services need to be loaded before tokenization"));var e={cardNumber:a.cardNumber||"",ccExpiresMonth:a.ccExpiresMonth||0,ccExpiresYear:a.ccExpiresYear||0,securityCode:a.securityCode||"",fullName:a.fullName||"",address:a.address||"",city:a.city||"",state:a.state||"",zipCode:a.zipCode,cardType:a.cardType||""},f=new XMLHttpRequest;f.open("POST",c._config.tokenizeCard(c._cached._services[0].companyId)),f.setRequestHeader("Accept","application/json"),f.setRequestHeader("Content-Type","application/json;charset=UTF-8"),f.onload=function(){if(200===f.status){var a=JSON.parse(f.responseText);if(a.isError)return void d(new Error(a.message));a.token.cardType=e.cardType||"",c._private.cardToken=a.token,b(a.token)}else d(new Error(JSON.parse(f.responseText)))},f.onerror=function(){d(new Error("Network Error"))},f.send(JSON.stringify(e))})},preAuthorizePayment:function(a,b){return new Promise(function(d,e){if(!c._cached.services)return void e(new Error("Services need to be loaded before tokenization"));var f;if(isNaN(a)?1:(f=parseFloat(a),(0|f)!==f))return e(new Error("Amount is required and must be an integer. Ex: 32.85 is passed as 3285"));a=parseInt(a,10);var g={cardNumber:b.cardNumber||"",ccExpiresMonth:b.ccExpiresMonth||0,ccExpiresYear:b.ccExpiresYear||0,securityCode:b.securityCode||"",fullName:b.fullName||"",address:b.address||"",city:b.city||"",state:b.state||"",zipCode:b.zipCode,amount:a},h=new XMLHttpRequest;h.open("POST",c._config.preAuthorizeCard(c._cached._services[0].companyId)),h.setRequestHeader("Accept","application/json"),h.setRequestHeader("Content-Type","application/json;charset=UTF-8"),h.onload=function(){if(200===h.status){var a=JSON.parse(h.responseText);if(a.isError)return void e(new Error(a.message));d(a.token)}else e(new Error(JSON.parse(h.responseText)))},h.onerror=function(){e(new Error("Network Error"))},h.send(JSON.stringify(g))})},saveServiceSelection:function(a,b){var d={account:c._private.account.id,services:a,isOneTime:a.length>1?!1:!0,amount:0,delayedCaptureToken:""};return b&&(d.material=b),new Promise(function(a,b){var e=Parse.Object.extend("Order"),f=new e;f.save(d).then(function(b){c._private.order=b,a(b)},function(a){b(a)})})},saveServiceInformation:function(a){var b={firstName:a.firstName||"",lastName:a.lastName||"",email:a.email||"",phone:a.phone||"",address:a.address||"",street:a.street||"",city:a.city||"",state:a.state||"",suite:a.suite||"",zip:a.zip||"",comments:a.comments||""};return new Promise(function(a,d){var e=c._private.account;e.set("serviceSite",b),e.save().then(function(b){c._private.account=b,a(b)},function(a){d(a)})})},setRecurringStartDate:function(a){return new Promise(function(b,d){var e=c._private.order;e.set("recurringStarts",a),e.save().then(function(a){c._private.order=a,b(a)},function(a){d(a)})})},setOnDemandDates:function(a,b){return new Promise(function(d,e){var f=c._private.order;f.set("deliveryDate",a),f.set("removalDate",b),f.save().then(function(a){c._private.order=a,d(a)},function(a){e(a)})})},saveBillingSelection:function(a){var b={account:c._private.account.id,name:a.name,street:a.street,city:a.city,state:a.state,zip:a.zip,phone:a.phone||c._private.account.serviceSite.phone};return new Promise(function(a,d){c._private.account.set("billingInfo",b),c._private.account.save().then(function(b){a(b)},function(a){d(a)})})},setBillingOptions:function(a,b){return new Promise(function(d,e){var f=c._private.account;return f?(f.set("isAutoPay",a||!1),f.set("isPaperless",b||!1),void f.save().then(function(a){c._private.account=a,d(a)},function(a){e(a)})):e(new Error("Account must be created before setting billing options"))})},processQuoteRequest:function(a,b){return new Promise(function(d,e){var f={account:b||c._private.account||null,lobGuid:a||null};if(!f.lobGuid)return void e(new Error("Service category required before processing quote."));if(!f.account)return void e(new Error("Service information (account) required before processing quote."));var g=new XMLHttpRequest;g.open("POST",c._config.processQuote()),g.setRequestHeader("Accept","application/json"),g.setRequestHeader("Content-Type","application/json;charset=UTF-8"),g.onload=function(){201===g.status||200===g.status?d():e(new Error(g.statusText))},g.onerror=function(){e(new Error("Network Error"))},g.send(JSON.stringify(f))})},processNewOrder:function(a,b,d){return new Promise(function(e,f){var g={account:a||c._private.account||null,order:b||c._private.order||null,card:d||c._private.cardToken||null};if(!g.account)return void f(new Error("Service and billing information (account) required before processing order."));if(!g.order)return void f(new Error("Requested services (order) required before processing order."));if(!g.card&&c._private.ccRequired)return void f(new Error("Credit card token required before processing order."));var h=new XMLHttpRequest;h.open("POST",c._config.processOrder()),h.setRequestHeader("Accept","application/json"),h.setRequestHeader("Content-Type","application/json;charset=UTF-8"),h.onload=function(){if(201===h.status||200===h.status){var a=JSON.parse(h.responseText);c._private.encoreAccount=a,c._private.account.set("encoreAccount",a),c._private.account.save(),e(a)}else f(new Error(h.statusText))},h.onerror=function(){f(new Error("Network Error"))},h.send(JSON.stringify(g))})},createTempAccount:function(a){var b=!1,d={accountNumber:0,primaryNumber:a.primaryNumber||0,street:a.street||"",lat:a.lat||0,lon:a.lon||0,city:a.city||"",state:a.stateShort||a.state||"",zip:a.zip||"",rdi:a.rdi||"",isTempAccount:!0,isMultiSearcher:b};return new Promise(function(a,b){var e=Parse.Object.extend("Account"),f=new e;f.save(d).then(function(b){c._private.account=b,c.URL.setHash("account",b.id),a(b)},function(a){b(a)})})},initialize:function(a,b){return new Promise(function(d,e){c._private.parseAppId=a,c._private.parseJsKey=b,Parse.initialize(a,b);var f=Parse.Object.extend("Config"),g=new Parse.Query(f);g.first().then(function(a){c._private.organizationToken=a.get("wasteMateOrg");var b=a.get("wasteMateHost");c._private.host=b||c._private.host,c._cached.clear(),c.getServiceCategories().then(function(a){d(a)},function(a){e(a)})},function(a){e(a)})})}};c.URL={getHash:function(a,b){var c=window.location.hash,d=c.substring(c.indexOf("=")+1);return d?d:b},setHash:function(a,b){window.location.hash=a+"="+b},appendHash:function(a,b){var d=window.location.hash;d&&d.length>0?window.location.hash+="&"+a+"="+b:c.URL.setHash(a,b)},getQuery:function(a,b){var c=window.location.search,d=c.substring(c.indexOf("=")+1);return d?d:b}},c.noConflict=function(){return a.wastemate=b,c},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=c),exports.wastemate=c):a.wastemate=c}.call(this);var DateHelper={getHolidays:function(){var a=[{holiday:"Labor Day",date:"September 7, 2015"},{holiday:"Columbus Day",date:"October 12, 2015"},{holiday:"Veterans Day",date:"November 11, 2015"},{holiday:"Thanksgiving Day",date:"November 26, 2015"},{holiday:"Friday after Thanksgiving",date:"November 27, 2015"},{holiday:"Christmas Day",date:"December 25, 2015"},{holiday:"New Year's Day",date:"January 1, 2016"},{holiday:"Martin Luther King, Jr. Day",date:"January 18, 2016"},{holiday:"Presidents Day",date:"February 15, 2016"},{holiday:"Easter",date:"March 27, 2016"},{holiday:"Memorial Day",date:"May 30, 2016"},{holiday:"Independence Day",date:"July 4, 2016"},{holiday:"Labor Day",date:"September 5, 2016"},{holiday:"Columbus Day",date:"October 10, 2016"},{holiday:"Veterans Day",date:"November 11, 2016"},{holiday:"Thanksgiving Day",date:"November 24, 2016"},{holiday:"Friday after Thanksgiving",date:"November 25, 2016"},{holiday:"Christmas Day",date:"December 26, 2016"}];return _.each(a,function(a){a.date=new Date(a.date)}),a},getHoliday:function(a){return _.find(DateHelper.getHolidays(),function(b){return moment(a).isSame(b.date,"day")})||!1},isWeekday:function(a){var b=moment(a).isoWeekday();return b>=1&&5>=b?moment(a):!1},isServiceDay:function(a){return self.serviceDay==moment(a).isoWeekday-1?moment(a):!1}};Date.prototype.toJSONLocal=function(){var a=new Date(this);return a.setMinutes(this.getMinutes()-this.getTimezoneOffset()),a.toISOString().slice(0,10)},ko.observableArray.fn.refresh=function(){var a=this();this([]),this(a)},ko.extenders.required=function(a,b){function c(c){a.hasError(c?!1:!0),a.validationMessage(c?"":b||"This field is required")}return a.hasError=ko.observable(),a.validationMessage=ko.observable(),c(a()),a.subscribe(c),a},ko.bindingHandlers.backgroundImage={update:function(a,b){ko.bindingHandlers.style.update(a,function(){return{backgroundImage:"url('"+_wastemate.site.baseUrl+b()+"')"}})}},ko.bindingHandlers.mapAddress={update:function(a,b){ko.bindingHandlers.html.update(a,function(){var a=ko.unwrap(b());return a?'<i class="fa fa-map-marker"></i> '+a:"&nbsp;"})}};var _debug=window._debug||!1,setupLiveAddressGoogle=function(a){var b={types:["address"],componentRestrictions:{country:"us"}};if(void 0!=_wastemate.search_bounds){var c=_wastemate.search_bounds,d=new google.maps.LatLngBounds(new google.maps.LatLng(c.latTop,c.lonLeft),new google.maps.LatLng(c.latBottom,c.lonRight));b.bounds=d}var e=function(){if(void 0!=a.pendingOrder.line){var b=a.pendingOrder.line,c=!1;_.each(a.categories(),function(d){d.line==b&&(a.loadCategory(d),c=!0)}),c||(console.log("Service selected was not avaialbe for auto selection"),a.show("categories")),a.pendingOrder.line=void 0;var d=$("#"+_wastemate.ui.hide||"body");d&&(a.shouldShowWMA(!0),d.hide())}else $("#signUp").modal("hide"),a.show("categories");window.scrollTo(window.scrollX,0)},f=_wastemate.ui.main||"wastemate-ordering",g=document.getElementById(f),h=new google.maps.places.Autocomplete(g,b);google.maps.event.addListener(h,"place_changed",function(){var a=h.getPlace();k([a],e)});var i=(_wastemate.ui.search||"wastemate-address",document.getElementById("floating_address"));if(i){var j=new google.maps.places.Autocomplete(i,b);google.maps.event.addListener(j,"place_changed",function(){var a=j.getPlace();k([a],e)})}var k=function(a,b){var c,d=a[0].address_components;try{var e=l(d,"street_number","long"),f=l(d,"route","short"),g=l(d,"postal_code","long"),h=l(d,"postal_code_suffix","long");if(c={primaryNumber:e,street:e&&f?e+" "+f:null,city:l(d,"locality","long"),stateShort:l(d,"administrative_area_level_1","short"),zip:g?g+(h?"-"+h:""):null,lat:a[0].geometry.location.lat()||null,lon:a[0].geometry.location.lng()||null,rdi:""},!(c.street&&c.primaryNumber&&c.city&&c.stateShort&&c.zip&&c.lat&&c.lon))return void alert("Oops. Bad address. Please enter your full address.")}catch(i){throw i}m(c,b)},l=function(a,b,c){var d=_.find(a,function(a){return _.contains(a.types,b)});return d?"long"===c?d.long_name:d.short_name:null},m=function(b,c){var d=function(){a.address(""),a.serviceAddress(""),a.serviceCity(""),a.serviceStateShort(""),a.serviceZip("")};a.userLatLon({lat:b.lat,lon:b.lon}),a.address(b),a.serviceAddress(b.street),a.serviceCity(b.city),a.serviceStateShort(b.stateShort),a.serviceZip(b.zip),wastemate.createTempAccount(b).then(function(b){_debug&&console.log(b),wastemate.getServiceDayOfWeek().then(function(b){var e=!1;if(_.each(a.categories(),function(a){a.isRecurring&&b?a.isVisbile=!0:a.isRecurring||(e=!0)}),!b&&!e)return d(),void alert("Oh drats, we don't have your address configured for online sign up. Call our office to speak to a human. "+_wastemate.ui.error_phone);if(b.length>0){var f=b[0];a.serviceDay(f.dow)}return $("#lob_address").css("border","2px solid #007700"),c?(c(),void console.log("next")):void(_debug&&console.log(b))},function(a){_debug&&console.log(a),$("#lob_address").css("border","2px solid #FFCCCC"),d(),alert("Oh drats, we don't have your address configured for online sign up. Call our office to speak to a human. "+_wastemate.ui.error_phone)})})}},isMapInitialized=!1,setupMiniMap=function(a,b){if(isMapInitialized)return void console.log("map already initiatlized");if(isMapInitialized=!0,console.log("setupMiniMap"),a&&b){var c,d,e,f=L.tileLayer("https://api.tiles.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiamVkZGF3c29uIiwiYSI6ImMxYjczZWRkNzFkNWU3YzhmMTAyNzdjMjBlYThiODk2In0.HsgA69IWdvwYJyaCT7TUUg"),e=L.map("interactive_map",{zoomControl:!1,attributionControl:!1,minZoom:18}).addLayer(f);e.setView([a,b],18);var g=L.marker(e.getCenter()).addTo(e);g.setOpacity(.3);var h=L.marker(e.getCenter()).addTo(e);e.on("move",function(){h.setLatLng(e.getCenter())}),e.on("moveend",function(){c=h.getLatLng().lat,d=h.getLatLng().lng,_wastemate.viewModel.userLatLon({lat:c,lon:d}),console.log(_wastemate.viewModel.userLatLon())})}};$(document).ready(function(){var a=new viewModel;_wastemate.viewModel=a,ko.applyBindings(a),wastemate.initialize(_wastemate.APP_KEY,_wastemate.JS_KEY).then(function(b){0==_wastemate.ui.widget&&a.shouldShowWMA(!0),a.show("search"),void 0===_wastemate.REQUIRE_CC&&(_wastemate.REQUIRE_CC=!0),void 0===_wastemate.site.baseUrl&&(_wastemate.site.baseUrl=""),wastemate._private.ccRequired=_wastemate.REQUIRE_CC,a.skipValidateCC=!wastemate._private.ccRequired,setupLiveAddressGoogle(a),$.each(b,function(b,c){c.isRecurring?c.isVisible=!1:c.isVisible=!0,a.categories.push(c)}),bindViewFormatters()},function(a){console.log(a),alert("Unable to connect. Double check the settings!"),$("#loading").fadeOut(),$("#initialize").fadeIn()}),window.onhashchange=function(){a.previous()},void 0===_wastemate.ui.button&&(_wastemate.ui.button="wastemate-service-order"),$("."+_wastemate.ui.button).on("click",function(){var b=$(this),c=b.data("serviceGuid"),d=b.data("serviceLine");a.buttonOrderService(c,d)});var b=qs.s,c=qs.l;b&&c?a.buttonOrderService(b,c):c&&a.buttonOrderService(null,c)});var qs=function(a){if(""==a)return{};for(var b={},c=0;c<a.length;++c){var d=a[c].split("=",2);1==d.length?b[d[0]]="":b[d[0]]=decodeURIComponent(d[1].replace(/\+/g," "))}return b}(window.location.search.substr(1).split("&"));